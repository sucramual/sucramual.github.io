<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title | default('Home') }} - Marcus Lau</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="icon" type="image/png" href="/assets/images/logo.png?v=2" />
    <link rel="apple-touch-icon" href="/assets/images/logo.png?v=2" />
</head>
<body class="bg-background text-text min-h-screen">

    <!-- Fixed TOC Sidebar — only on post pages, only on wide screens (shown via JS) -->
    <aside id="toc-sidebar" style="display:none; position:fixed; left:max(16px, calc(50% - 640px)); top:100px; width:200px; font-size:0.875rem;">
        <h3 style="font-weight:700; margin:0 0 16px 0; font-size:1rem; font-family:inherit;">Contents</h3>
        <nav id="toc-list" style="display:flex; flex-direction:column; gap:10px;">
            <!-- TOC links injected by JS -->
        </nav>
    </aside>

    <div class="max-w-2xl mx-auto px-4 py-8">
        <header class="mb-12">
            <nav class="flex justify-between items-center mb-16">
                <a href="/" class="text-xl font-serif hover:text-link-hover transition-colors">Marcus Lau</a>
                <div class="space-x-6">
                    <a href="/" class="nav-link">About</a>
                    <a href="/projects" class="nav-link">Projects</a>
                    <a href="/writing" class="nav-link">Writing</a>
                </div>
            </nav>
        </header>

        <main class="prose">
            {{ content | safe }}

            {% if references %}
            <section style="margin-top:48px; padding-top:24px; border-top:1px solid #e5e7eb;">
                <h2 style="font-size:1.1em; margin-top:0; margin-bottom:16px;">References</h2>
                <ol style="padding-left:24px; margin:0; list-style:decimal;">
                    {% for ref in references %}
                    <li id="ref-{{ loop.index }}" style="margin-bottom:12px; font-size:0.9em; line-height:1.5;">
                        {% if ref.authors %}{{ ref.authors }}. {% endif %}
                        {% if ref.url %}
                            <a href="{{ ref.url }}" class="text-link hover:text-link-hover">{{ ref.title }}</a>
                        {% else %}
                            {{ ref.title }}
                        {% endif %}
                        {% if ref.venue %}. <em>{{ ref.venue }}</em>{% endif %}
                        {% if ref.year %} ({{ ref.year }}){% endif %}.
                    </li>
                    {% endfor %}
                </ol>
            </section>
            {% endif %}
        </main>

        <footer class="mt-16 pt-8 border-t border-gray-200 text-sm text-gray-600">
            <p>&copy; 2026 Marcus Lau</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const articleContent = document.querySelector('main.prose');
            const sidebar = document.getElementById('toc-sidebar');
            const tocList = document.getElementById('toc-list');
            if (!articleContent) return;

            // --- Date + Read Time ---
            const h1 = articleContent.querySelector('h1');
            if (h1) {
                // Word count → read time
                const words = articleContent.innerText.trim().split(/\s+/).length;
                const mins = Math.max(1, Math.round(words / 200));

                const meta = document.createElement('p');
                meta.style.cssText = 'margin:0px 0 50px 0; font-size:1.0rem; color:#888; font-family:inherit;';
                meta.innerHTML = `{{ date | date("DD MMM YYYY") }} &middot; ${mins} min read`;
                h1.insertAdjacentElement('afterend', meta);
            }

            // Only show TOC on wide screens (≥1300px)
            if (!sidebar || !tocList) return;
            function checkWidth() {
                sidebar.style.display = window.innerWidth >= 1300 ? 'block' : 'none';
            }

            // Build TOC from h2 and h3 headings
            const headings = articleContent.querySelectorAll('h2, h3');
            if (headings.length === 0) return;

            headings.forEach(heading => {
                if (!heading.id) {
                    heading.id = heading.textContent.trim().toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/(^-|-$)/g, '');
                }

                const link = document.createElement('a');
                link.href = '#' + heading.id;
                link.textContent = heading.textContent;
                link.className = 'toc-link';
                Object.assign(link.style, {
                    color: '#b0a99f',
                    textDecoration: 'none',
                    lineHeight: '1.4',
                    transition: 'color 0.15s ease'
                });
                if (heading.tagName === 'H3') {
                    link.style.paddingLeft = '12px';
                    link.style.fontSize = '0.8rem';
                }
                link.addEventListener('mouseenter', () => {
                    if (!link.classList.contains('active')) link.style.color = '#000';
                });
                link.addEventListener('mouseleave', () => {
                    if (!link.classList.contains('active')) link.style.color = '#b0a99f';
                });
                tocList.appendChild(link);
            });

            // Scroll-spy: highlight the active section
            const tocLinks = document.querySelectorAll('.toc-link');

            function setActiveLink() {
                let currentActive = null;
                headings.forEach(section => {
                    if (window.scrollY + 120 >= section.offsetTop) {
                        currentActive = tocList.querySelector(`a[href="#${section.id}"]`);
                    }
                });
                tocLinks.forEach(link => {
                    link.classList.remove('active');
                    link.style.color = '#b0a99f';
                    link.style.fontWeight = 'normal';
                });
                if (currentActive) {
                    currentActive.classList.add('active');
                    currentActive.style.color = '#000';
                    currentActive.style.fontWeight = '700';
                }
            }

            // Smooth scroll on click
            tocLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        window.scrollTo({ top: target.offsetTop - 20, behavior: 'smooth' });
                        history.pushState(null, null, this.getAttribute('href'));
                    }
                });
            });

            checkWidth();
            window.addEventListener('resize', checkWidth);
            setActiveLink();
            window.addEventListener('scroll', setActiveLink);
        });
    </script>
</body>
</html>
